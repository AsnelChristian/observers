<html>
<head>
  <meta charset="utf-8"/>
  <!--<link href="css/vendor/bootstrap.min.css" rel="stylesheet"/>
  <link href="css/vendor/bootstrap-theme.min.css" rel="stylesheet"/>
  
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.7/jquery.validate.min.js"></script>
  <script type="text/javascript" src="js/vendor/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/vendor/knockout-3.0.0.js"></script>-->
</head>

<body>
<div class="modal-dialog" id="sharestory-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Submit a report</h4>
      </div>
      <div class="modal-body">

      <div id ="successStatus"> </div>

      <form class="form" role="form"  id="sharestory-form" method = "post" action="">
        <fieldset>

      <div class="form-group">
        <p class="help-block" >
          You can share the story through: the web form below, tweets on a given account or SMS. More info about the other methods is coming soon.</p>
        <!-- <div class="panel-group" id="accordion" data-bind="template: {name: templateToUse, foreach: channels}"> -->
      </div>

        <div class="form-group">
          <label for="name" class="sr-only  control-label">Screen name</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Screen name" data-bind="value: authorName">
        </div>

        <div class="form-group">
           <label for="report" class="sr-only  control-label">Report</label> 
            <textarea class="form-control" rows="2" id="report" name="report" placeholder="Your report" data-bind="value: report"></textarea>
        </div>

        <div class="form-group ">
           <label for="selectedOpinion" class="control-label">Please tell us what is the sentiment of your report. (Optional)</label> 
            <select class="form-control" id="selectedOpinion" name="opinion" data-bind="options: opinionList, value: selectedOpinion, optionsCaption: 'Choose...'"></select>
        </div>

          <div class="form-group">
            <label for="attachment" class="control-label">Attachment</label>
            <input type="file" id="mediaFiles" name="mediaFiles" data-bind="event: { change: function(data, event){ mediaFiles(event.target.files);} }"/> 
            <p class="help-block" data-bind="text: mediaText"></p>
          </div>

      </fieldset>
    </form>

  </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button id="share-story-submit" type="button" class="btn btn-primary">Submit report</button>
      </div>
    </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->

<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.7/jquery.validate.min.js"></script>

<script type="text/javascript">
  var currentReportModel = null;

  /*function CloudStorageInfo () {
    var self = this;

    self.projectNumber = '907117162790';
    self.clientId = '907117162790.apps.googleusercontent.com';
    self.apiKey = '***REMOVED***';
    self.scopes = 'https://www.googleapis.com/auth/devstorage.full_control';
    self.api_version = 'v1beta1';
    self.bucket = 'observers-bucket';
  }*/

  function SendReportModel (topicId) {
    var self = this;

    self.topicId = topicId;

    self.authorName = ko.observable();
    self.report = ko.observable();
    self.mediaUrls = ko.observableArray([]);

    self.mediaFiles = ko.observable();
    self.mediaText = ko.observable("Add a document to support your report.");

    self.opinionList = ko.observableArray(['Unknown',  'Neutral', 'Positive', 'Negative']);
    self.selectedOpinion = ko.observable();

    /*self.mediaFiles.subscribe(function(files) {
      for (var i = 0; i < files.length; i++) {
            // get item
            //var file = files.item(i);
            //or
            var file = files[i];
            self.uploadMediaFile(file);
        }
    });*/

    self.uploadMediaFile = function(fileData, callback) {
      function run () {
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        if (window.File && window.FileReader && window.FileList && window.Blob) {
          //do your stuff!
        } else {
          alert('File upload are not fully supported by your browser.');
          return;
        }

        var reader = new FileReader();
        reader.onload = function(e) {
          var contentType = fileData.type || 'application/octet-stream';
          var metadata = {
            'name': fileData.name,
            'mimeType': contentType
          };

          var base64Data = btoa(reader.result);
          var multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: ' + contentType + '\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Data +
            close_delim;

          //Note: gapi.client.storage.objects.insert() can only insert
          //small objects (under 64k) so to support larger file sizes
          //we're using the generic HTTP request method gapi.client.request()
          var request = gapi.client.request({
            'path': '/upload/storage/v1beta2/b/' + "observers-bucket" + '/o',
            'method': 'POST',
            'params': {'uploadType': 'multipart'},
            'headers': {
              'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
            },
            'body': multipartRequestBody});
            
            try {
              //alert("Upload " + fileData);
             request.execute(function(resp) {
                if (resp['error'])
                {
                  var msg = "We were unable to upload your file. Please try again later";
                $("#successStatus").html("<div class='alert alert-danger'>"+msg +"</div>");
                  alert(JSON.stringify(resp));
                } else
                {
                  self.mediaText("Thanks for uploading your file. It is now available at <a>" + resp["mediaLink"] + "</a>");
                  self.mediaUrls.push(resp["mediaLink"]);

                  /*var resource = {
                      'entity': 'allUsers',
                      'role': 'READER'
                    };
                    var orequest = gapi.client.storage.objectAccessControls.insert({
                        'bucket': resp["bucket"],
                        'object': resp["name"],
                        'resource': resource
                    });
                    orequest.execute(function(resp) { console.log(resp) } );*/

                  if (callback != undefined)
                    callback();
                  //$('#mediaFilePath').hide();

                }
                jQuery('.modal-body').hideLoading();
              });
            }
            catch(e) {
              alert('An error has occurred: ' + e.message);
              jQuery('.modal-body').hideLoading();
            }
          };
          reader.readAsBinaryString(fileData);
      }

        runOnceAuthenticated(run, $("#successStatus"));
    };

    self.saveChanges = function() {
        jQuery('.modal-body').showLoading();
        if (navigator.geolocation) {
          var geo_options = {
            enableHighAccuracy: false, 
            maximumAge        : 6000000, 
            timeout           : 2000
          };

          navigator.geolocation.getCurrentPosition(function(position) {
             sendReport(position)
          }, function(error) {
              sendReport(null);
          }, geo_options
          );
      } else {
          // Fallback for no geolocation
          sendReport(null);
      }
      
    };

    currentReportModel = self;
  }

   function sendReport (position)
      {

        function run () {
        
        $.ajax({
              url: 'api/reports?topicId=' +  currentReportModel.topicId,
              type: 'POST',
              data: JSON.stringify({
                content: currentReportModel.report(), 
                authorId: currentReportModel.authorName(), 
                mood: currentReportModel.selectedOpinion(), 
                mediaUrls:currentReportModel.mediaUrls(),
                location: (position == undefined || position == null)?null:{lat: position.coords.latitude, lng: position.coords.longitude}
              }),
              contentType: 'application/json; charset=utf-8',
              dataType: 'json',
              async: true,
              success: function(result) {
                $("#successStatus").html("<div class='alert alert-success'>"+"Thank you " + currentReportModel.authorName() + ", your report was submitted" +"</div>");
                currentReportModel.authorName(null);
                currentReportModel.report(null);
                currentReportModel.mediaUrls([]);
                currentReportModel.selectedOpinion(null);
                currentReportModel.mediaUrls([]);
                currentReportModel.mediaFiles(null);
                window.location.href = "dashboard.html?topicId="+currentReportModel.topicId;
                //window.setTimeout(function() { $('#sharestory-dialog').modal('hide') }, 1000);
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                var msg = "We were unable to sign you in: " + textStatus + ". Please try again later";
                $("#successStatus").html("<div class='alert alert-danger'>"+msg +"</div>");
                console.log("some error occured: ", errorThrown);
              }, complete: function() {
                jQuery('.modal-body').hideLoading();
              }
        });
      }

        function runWithMediaUpload()
        {
          console.log("Start sendin report!!!");
          if (currentReportModel.mediaFiles() != null && currentReportModel.mediaFiles().length > 0)
          {
            currentReportModel.uploadMediaFile(currentReportModel.mediaFiles()[0], run);
          }
          else run();
        }

        console.log("Authenticate user!!!");
        runOnceAuthenticated(runWithMediaUpload, $("#successStatus"));
      };


  (function () {
    $('#share-story-submit').on('click', function(e){
      // We don't want self to act as a link so cancel the link action
      e.preventDefault();
      $('#sharestory-form').submit();
    });

    $('#sharestory-form').validate({
        debug: true,
        rules: {
            name: {
                minlength: 2,
                maxlength: 30,
                required: false
            },
            report: {
                minlength: 10,
                maxlength: 300,
                required: true
            },
            opinion: {
              required: false
            }
        },
        highlight: function (element) {
            $(element).closest('.form-group')
                .removeClass('has-success').addClass('has-error');
        },
        success: function (element) {
            element.addClass('valid').closest('.form-group')
                .removeClass('has-error').addClass('has-success');
        },
        errorClass: "help-block",
        validClass: "help-block",
        submitHandler: function (form) {
            console.log("Submit");
            currentReportModel.saveChanges();
            return false; // ajax used, block the normal submit
        }
    });

}());

</script>

</body>
</html>